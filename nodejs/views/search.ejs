<%- include('partials/header', { 
    title: 'Search Transactions - InjectiBank',
    user: user 
}) %>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="card-title mb-0">Transaction Search</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="/search" class="row g-3">
                        <!-- Company Name -->
                        <div class="col-md-6">
                            <label for="company" class="form-label">Company Name</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="company" 
                                   name="company" 
                                   placeholder="Enter company name"
                                   value="<%= company || '' %>">
                        </div>

                        <!-- Date Range -->
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="start_date" 
                                   name="start_date"
                                   value="<%= start_date || '' %>">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" 
                                   class="form-control" 
                                   id="end_date" 
                                   name="end_date"
                                   value="<%= end_date || '' %>">
                        </div>

                        <!-- Amount Range -->
                        <div class="col-md-3">
                            <label for="min_amount" class="form-label">Min Amount</label>
                            <input type="number" 
                                   step="0.01" 
                                   class="form-control" 
                                   id="min_amount" 
                                   name="min_amount"
                                   placeholder="0.00"
                                   value="<%= min_amount || '' %>">
                        </div>
                        <div class="col-md-3">
                            <label for="max_amount" class="form-label">Max Amount</label>
                            <input type="number" 
                                   step="0.01" 
                                   class="form-control" 
                                   id="max_amount" 
                                   name="max_amount"
                                   placeholder="0.00"
                                   value="<%= max_amount || '' %>">
                        </div>

                        <!-- Search Mode -->
                        <div class="col-md-6">
                            <label for="search_mode" class="form-label">Search Mode</label>
                            <select class="form-select" id="search_mode" name="search_mode">
                                <option value="basic" <%= search_mode === 'basic' ? 'selected' : '' %>>
                                    Basic Search (Recommended)
                                </option>
                                <option value="advanced" <%= search_mode === 'advanced' ? 'selected' : '' %>>
                                    Advanced Search
                                </option>
                            </select>
                            <div class="form-text">
                                Advanced search provides more flexibility but may be slower.
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Search Transactions
                            </button>
                            <a href="/search" class="btn btn-outline-secondary ms-2">Clear</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Search Results -->
            <% if (typeof transactions !== 'undefined') { %>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            Search Results 
                            <% if (transactions.length > 0) { %>
                                <span class="badge bg-primary ms-2"><%= transactions.length %></span>
                            <% } %>
                        </h5>
                        <% if (transactions.length > 0) { %>
                            <a href="/export?<%= new URLSearchParams({
                                company: company || '',
                                start_date: start_date || '',
                                end_date: end_date || '',
                                min_amount: min_amount || '',
                                max_amount: max_amount || '',
                                search_mode: search_mode || 'basic'
                            }).toString() %>" class="btn btn-sm btn-success">
                                <i class="fas fa-download me-1"></i>Export CSV
                            </a>
                        <% } %>
                    </div>
                    <div class="card-body">
                        <% if (transactions.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Company</th>
                                            <th>Description</th>
                                            <th>Category</th>
                                            <th class="text-end">Amount</th>
                                            <th class="text-end">Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% transactions.forEach(function(transaction) { %>
                                        <tr>
                                            <td><%= transaction.date.toLocaleDateString() %></td>
                                            <td><%= transaction.company %></td>
                                            <td class="text-truncate" style="max-width: 250px;" title="<%= transaction.description %>">
                                                <%= transaction.description %>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">
                                                    <%= transaction.category || 'Other' %>
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <span class="<%= transaction.amount >= 0 ? 'text-success' : 'text-danger' %>">
                                                    <%= transaction.amount >= 0 ? '+' : '' %>$<%= transaction.amount.toFixed(2) %>
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                $<%= parseFloat(transaction.balance || 0).toFixed(2) %>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Summary -->
                            <div class="row mt-3 pt-3 border-top">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        Showing <%= transactions.length %> transaction<%= transactions.length !== 1 ? 's' : '' %>
                                    </small>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <small class="text-muted">
                                        Total: 
                                        <% const total = transactions.reduce((sum, t) => sum + t.amount, 0); %>
                                        <strong class="<%= total >= 0 ? 'text-success' : 'text-danger' %>">
                                            <%= total >= 0 ? '+' : '' %>$<%= total.toFixed(2) %>
                                        </strong>
                                    </small>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-search fa-3x mb-3"></i>
                                <h5>No transactions found</h5>
                                <p>Try adjusting your search criteria</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
