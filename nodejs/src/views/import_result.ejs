<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Secure Banking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-bank me-2"></i>Secure Banking
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person me-1"></i><%= user.firstName %> <%= user.lastName %>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile"><i class="bi bi-person-gear me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="/preferences"><i class="bi bi-gear me-2"></i>Preferences</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/import">Import</a></li>
                <li class="breadcrumb-item active" aria-current="page">Results</li>
            </ol>
        </nav>

        <!-- Results Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-1">
                            <% if (success) { %>
                                <i class="bi bi-check-circle text-success me-2"></i>Import Complete
                            <% } else { %>
                                <i class="bi bi-x-circle text-danger me-2"></i>Import Failed
                            <% } %>
                        </h1>
                        <p class="text-muted mb-0">Import processing results</p>
                    </div>
                    <div class="btn-group">
                        <a href="/import" class="btn btn-outline-primary">
                            <i class="bi bi-upload me-2"></i>Import More
                        </a>
                        <a href="/dashboard" class="btn btn-outline-secondary">
                            <i class="bi bi-house me-2"></i>Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Import Results -->
                <div class="card">
                    <div class="card-header <%= success ? 'bg-success' : 'bg-danger' %> text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-check me-2"></i>Import Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <% if (success) { %>
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>Success!</strong> Import processing completed.
                            </div>
                        <% } else { %>
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Failed!</strong> Import processing encountered errors.
                            </div>
                        <% } %>

                        <!-- Import Statistics -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="bi bi-check-circle text-success fs-3 mb-2"></i>
                                        <h4 class="text-success mb-1"><%= result.imported_count || 0 %></h4>
                                        <small class="text-muted">Records Imported</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="bi bi-x-circle text-danger fs-3 mb-2"></i>
                                        <h4 class="text-danger mb-1"><%= result.failed_count || 0 %></h4>
                                        <small class="text-muted">Records Failed</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error Information -->
                        <% if (result.error) { %>
                        <div class="alert alert-danger">
                            <strong>Error Details:</strong>
                            <pre class="mb-0 mt-2"><%= result.error %></pre>
                        </div>
                        <% } %>

                        <!-- Formula Execution Results (for JSON templates) -->
                        <% if (result.formulas_executed && result.formulas_executed.length > 0) { %>
                        <div class="mt-4">
                            <h6>Formula Execution Results:</h6>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Security Notice:</strong> The following formulas were executed during import processing.
                            </div>
                            <% result.formulas_executed.forEach(function(formula) { %>
                            <div class="card mb-2">
                                <div class="card-body">
                                    <% if (formula.command) { %>
                                        <strong>Command:</strong> <code><%= formula.command %></code><br>
                                    <% } %>
                                    <% if (formula.formula) { %>
                                        <strong>Formula:</strong> <code><%= formula.formula %></code><br>
                                    <% } %>
                                    <% if (formula.result !== undefined) { %>
                                        <strong>Result:</strong> <span class="text-success"><%= JSON.stringify(formula.result) %></span>
                                    <% } %>
                                    <% if (formula.error) { %>
                                        <strong>Error:</strong> <span class="text-danger"><%= formula.error %></span>
                                    <% } %>
                                </div>
                            </div>
                            <% }); %>
                        </div>
                        <% } %>

                        <!-- Configuration Processing Results (for YAML) -->
                        <% if (result.config_processed) { %>
                        <div class="mt-4">
                            <h6>Configuration Processing:</h6>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Configuration file was successfully parsed and processed.
                            </div>
                            <% if (result.processor_result !== undefined) { %>
                            <div class="card">
                                <div class="card-body">
                                    <strong>Processor Result:</strong> 
                                    <pre class="mt-2"><%= JSON.stringify(result.processor_result, null, 2) %></pre>
                                </div>
                            </div>
                            <% } %>
                            <% if (result.processor_error) { %>
                            <div class="alert alert-warning">
                                <strong>Processor Error:</strong> <%= result.processor_error %>
                            </div>
                            <% } %>
                        </div>
                        <% } %>

                        <!-- Script Execution Results -->
                        <% if (result.script_processed) { %>
                        <div class="mt-4">
                            <h6>Script Processing:</h6>
                            <div class="alert alert-danger">
                                <i class="bi bi-shield-exclamation me-2"></i>
                                <strong>Security Warning:</strong> Configuration script processing was attempted.
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <strong>Execution Result:</strong> <%= result.execution_result %><br>
                                    <% if (result.script_content_preview) { %>
                                    <strong>Script Preview:</strong>
                                    <pre class="mt-2 small"><%= result.script_content_preview %></pre>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <% } %>

                        <!-- Processing Errors -->
                        <% if (result.errors && result.errors.length > 0) { %>
                        <div class="mt-4">
                            <h6>Processing Errors:</h6>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                The following errors occurred during processing:
                            </div>
                            <ul class="list-group">
                                <% result.errors.forEach(function(error) { %>
                                <li class="list-group-item list-group-item-warning">
                                    <small><%= error %></small>
                                </li>
                                <% }); %>
                            </ul>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Next Steps -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-list-check me-2"></i>Next Steps
                        </h6>
                    </div>
                    <div class="card-body">
                        <% if (success && result.imported_count > 0) { %>
                        <div class="list-group list-group-flush">
                            <a href="/transactions/search" class="list-group-item list-group-item-action">
                                <i class="bi bi-search me-2"></i>View Imported Transactions
                            </a>
                            <a href="/dashboard" class="list-group-item list-group-item-action">
                                <i class="bi bi-house me-2"></i>Return to Dashboard
                            </a>
                            <a href="/import" class="list-group-item list-group-item-action">
                                <i class="bi bi-upload me-2"></i>Import More Data
                            </a>
                        </div>
                        <% } else { %>
                        <div class="list-group list-group-flush">
                            <a href="/import" class="list-group-item list-group-item-action">
                                <i class="bi bi-arrow-clockwise me-2"></i>Try Import Again
                            </a>
                            <a href="/export" class="list-group-item list-group-item-action">
                                <i class="bi bi-download me-2"></i>Export Sample Data
                            </a>
                            <a href="/dashboard" class="list-group-item list-group-item-action">
                                <i class="bi bi-house me-2"></i>Return to Dashboard
                            </a>
                        </div>
                        <% } %>
                    </div>
                </div>

                <!-- Import Summary -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-bar-chart me-2"></i>Import Summary
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Processing Status:</span>
                                <span class="<%= success ? 'text-success' : 'text-danger' %>">
                                    <%= success ? 'Complete' : 'Failed' %>
                                </span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Records Processed:</span>
                                <span><%= (result.imported_count || 0) + (result.failed_count || 0) %></span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Success Rate:</span>
                                <span>
                                    <% 
                                    const total = (result.imported_count || 0) + (result.failed_count || 0);
                                    const rate = total > 0 ? Math.round(((result.imported_count || 0) / total) * 100) : 0;
                                    %>
                                    <%= rate %>%
                                </span>
                            </div>
                            <% if (result.config_processed) { %>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Configuration:</span>
                                <span class="text-info">Processed</span>
                            </div>
                            <% } %>
                            <% if (result.template_processed) { %>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Template:</span>
                                <span class="text-info">Processed</span>
                            </div>
                            <% } %>
                            <% if (result.script_processed) { %>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Script:</span>
                                <span class="text-warning">Analyzed</span>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>